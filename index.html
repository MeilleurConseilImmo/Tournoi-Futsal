<!doctype html>
<html lang="fr" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tournoi AS Chelles U11</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .match-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .match-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    
    .score-input {
      width: 60px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .admin-badge {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="w-full h-full bg-gradient-to-br from-blue-50 to-green-50 overflow-auto">
   <div class="max-w-6xl mx-auto px-4 py-8"><!-- Header -->
    <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
     <div class="flex items-center justify-between mb-4">
      <div>
       <h1 id="tournament-title" class="text-4xl font-bold text-blue-900 mb-2">Tournoi AS Chelles U11</h1>
       <p id="welcome-message" class="text-lg text-gray-600">Bienvenue au tournoi - Suivez les r√©sultats en direct</p>
      </div><img src="https://raw.githubusercontent.com/Vivien77500/Pr-senceU11/main/logo__sae7hi.png" alt="AS Chelles" class="w-24 h-24 object-contain" onerror="this.style.display='none'; this.outerHTML='<div class=\'text-6xl\'>‚öΩ</div>';">
     </div><!-- Admin Login -->
     <div id="admin-section" class="mt-6 pt-6 border-t border-gray-200">
      <div id="login-form" class="flex gap-3 items-center"><label for="password-input" class="font-semibold text-gray-700">Mode Admin:</label> <input type="password" id="password-input" placeholder="Mot de passe" class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"> <button id="login-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors"> Se connecter </button>
      </div>
      <div id="admin-status" class="hidden mt-2"><span class="admin-badge inline-flex items-center gap-2 px-4 py-2 bg-green-100 text-green-800 rounded-lg font-semibold"> üîì Mode Admin Actif </span> <button id="logout-btn" class="ml-3 px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition-colors"> Se d√©connecter </button>
      </div>
      <p id="login-error" class="hidden mt-2 text-red-600 font-semibold"></p>
     </div>
    </div><!-- Add Match Form (Admin Only) -->
    <div id="add-match-section" class="hidden bg-white rounded-2xl shadow-lg p-6 mb-8">
     <h2 class="text-2xl font-bold text-blue-900 mb-4">‚ûï Ajouter un Match</h2><button id="generate-all-matches-btn" class="w-full mb-4 px-6 py-3 bg-purple-600 text-white rounded-lg font-bold text-lg hover:bg-purple-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"> ‚ö° G√©n√©rer tous les matches de poules (Planning optimis√© 9h00-13h30) </button> <button id="generate-finals-btn" class="w-full mb-4 px-6 py-3 bg-orange-600 text-white rounded-lg font-bold text-lg hover:bg-orange-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"> üèÜ G√©n√©rer les phases finales (apr√®s les poules) </button> <button id="reset-tournament-btn" class="w-full mb-4 px-6 py-3 bg-red-600 text-white rounded-lg font-bold text-lg hover:bg-red-700 transition-colors"> üóëÔ∏è RAZ - Supprimer TOUS les matches </button>
     <form id="add-match-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div><label for="poule-select" class="block text-sm font-semibold text-gray-700 mb-2">Poule</label> <select id="poule-select" required class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"> <option value="">S√©lectionner une poule</option> <option value="Poule A">Poule A</option> <option value="Poule B">Poule B</option> <option value="Poule C">Poule C</option> <option value="Poule D">Poule D</option> <option value="Phase Finale 1">Phase Finale 1</option> <option value="Phase Finale 2">Phase Finale 2</option> <option value="Matchs de Classement">Matchs de Classement</option> </select>
      </div>
      <div><label for="team-home" class="block text-sm font-semibold text-gray-700 mb-2">√âquipe Domicile</label> <select id="team-home" required class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"> <option value="">Choisir l'√©quipe</option> </select>
      </div>
      <div><label for="team-away" class="block text-sm font-semibold text-gray-700 mb-2">√âquipe Ext√©rieur</label> <select id="team-away" required class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"> <option value="">Choisir l'√©quipe</option> </select>
      </div>
      <div><label for="match-time" class="block text-sm font-semibold text-gray-700 mb-2">Heure du Match</label> <input type="time" id="match-time" required class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
      </div>
      <div class="md:col-span-4"><button type="submit" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg font-bold text-lg hover:bg-green-700 transition-colors"> Cr√©er le Match </button>
      </div>
     </form>
    </div><!-- Filter Section -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8"><label for="poule-filter" class="block text-lg font-bold text-blue-900 mb-3">üîç S√©lectionner une Phase</label> <select id="poule-filter" class="w-full px-4 py-3 border-2 border-blue-300 rounded-lg focus:outline-none focus:border-blue-500 text-lg font-semibold"> <option value="all">üìã Choisir une phase...</option> <option value="Poule A">Poule A</option> <option value="Poule B">Poule B</option> <option value="Poule C">Poule C</option> <option value="Poule D">Poule D</option> <option value="Phase Finale 1">Phase Finale 1</option> <option value="Phase Finale 2">Phase Finale 2</option> <option value="Matchs de Classement">Matchs de Classement</option> </select>
    </div><!-- Matches List -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
     <h2 class="text-2xl font-bold text-blue-900 mb-6">üìã Matches du Tournoi</h2>
     <div id="matches-container" class="space-y-4">
      <p class="text-gray-500 text-center py-8">Aucun match pour le moment. Connectez-vous en mode admin pour ajouter des matches.</p>
     </div>
    </div><!-- Classement -->
    <div id="standings-section" class="bg-white rounded-2xl shadow-lg p-6 mt-8">
     <h2 class="text-2xl font-bold text-blue-900 mb-6">üèÜ Classement</h2>
     <div id="standings-container">
      <p class="text-gray-500 text-center py-8">Aucun r√©sultat pour le moment</p>
     </div>
    </div>
   </div>
  </div>
  <script>
    const ADMIN_PASSWORD = 'admin123';
    let isAdmin = false;
    let allMatches = [];
    let selectedPoule = 'all';
    let tournamentFinalized = false;
    
    const TEAMS = {
      'Chelles 1': 'https://raw.githubusercontent.com/Vivien77500/Pr-senceU11/main/logo__sae7hi.png',
      'Chelles 2': 'https://raw.githubusercontent.com/Vivien77500/Pr-senceU11/main/logo__sae7hi.png',
      'Chelles 3': 'https://raw.githubusercontent.com/Vivien77500/Pr-senceU11/main/logo__sae7hi.png',
      'Chelles 4': 'https://raw.githubusercontent.com/Vivien77500/Pr-senceU11/main/logo__sae7hi.png',
      'US Vaires': 'https://media.scorenco.com/media/image/club-logo-1742381817.73056.png',
      'US Torcy PVM': 'https://s3.static-footeo.com/1200/uploads/torcyfoot/logo__t1wiaz.png',
      'Claye Souilly Sports': 'https://raw.githubusercontent.com/Vivien77500/Pr-senceU11/main/imag.jpeg',
      'FC Gagny': 'https://fc-gagny.com/cdn/shop/files/Fc_Gagny_1.png?v=1718132797',
      'RC Gonnesse': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQxnjVyNuwPmewpkMZdI5V7o82xzdTAHYAM2g&s',
      'AS La Courneuve': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTtLe3sshM1jSmcdLZKhFkMvIqWr5lwhwd4jA&s',
      'Red Star FC': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/Logo_Red_Star_FC_2014.svg/250px-Logo_Red_Star_FC_2014.svg.png',
      'US Fontenay': 'https://www.us-fontenay.com/app/uploads/2020/11/Football_fdBLC_Bichro-1024x885.jpg',
      'Noisy le Grand FC': 'https://raw.githubusercontent.com/Vivien77500/Pr-senceU11/main/images.jpeg',
      'RC Joinville': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRkBEqSrirHezOL5RjgSsYyXRVcDByBdIF7nw&s',
      'Entente SSG': 'https://upload.wikimedia.org/wikipedia/fr/e/e7/Logo_Entente_Sannois_St_Gratien.svg',
      'Esp√©rance Aulnaysienne': 'https://tmssl.akamaized.net/images/wappen/head/82090.png?lm=1752884799'
    };
    
    const POULES = {
      'Poule A': ['Chelles 1', 'Claye Souilly Sports', 'Esp√©rance Aulnaysienne', 'Entente SSG'],
      'Poule B': ['Chelles 2', 'FC Gagny', 'Red Star FC', 'US Fontenay'],
      'Poule C': ['Chelles 3', 'US Vaires', 'Noisy le Grand FC', 'AS La Courneuve'],
      'Poule D': ['Chelles 4', 'US Torcy PVM', 'RC Gonnesse', 'RC Joinville']
    };

    // Fonctions de stockage local
    function saveToLocalStorage() {
      localStorage.setItem('tournoi_matches', JSON.stringify(allMatches));
      localStorage.setItem('tournoi_finalized', JSON.stringify(tournamentFinalized));
    }

    function loadFromLocalStorage() {
      const saved = localStorage.getItem('tournoi_matches');
      if (saved) {
        try {
          allMatches = JSON.parse(saved);
          renderMatches();
          updateStandings();
        } catch (e) {
          console.error('Erreur de chargement des donn√©es');
        }
      }
      
      const savedFinalized = localStorage.getItem('tournoi_finalized');
      if (savedFinalized) {
        try {
          tournamentFinalized = JSON.parse(savedFinalized);
        } catch (e) {
          tournamentFinalized = false;
        }
      }
    }

    function getPouleStandings() {
      const pouleStandings = {};

      allMatches.forEach(match => {
        if (!match.is_finished || !match.poule.startsWith('Poule ')) return;

        const poule = match.poule;
        
        if (!pouleStandings[poule]) {
          pouleStandings[poule] = {};
        }

        const teams = pouleStandings[poule];

        if (!teams[match.team_home]) {
          teams[match.team_home] = { name: match.team_home, played: 0, won: 0, drawn: 0, lost: 0, goalsFor: 0, goalsAgainst: 0, points: 0 };
        }
        if (!teams[match.team_away]) {
          teams[match.team_away] = { name: match.team_away, played: 0, won: 0, drawn: 0, lost: 0, goalsFor: 0, goalsAgainst: 0, points: 0 };
        }

        teams[match.team_home].played++;
        teams[match.team_away].played++;
        teams[match.team_home].goalsFor += match.score_home;
        teams[match.team_home].goalsAgainst += match.score_away;
        teams[match.team_away].goalsFor += match.score_away;
        teams[match.team_away].goalsAgainst += match.score_home;

        if (match.score_home > match.score_away) {
          teams[match.team_home].won++;
          teams[match.team_home].points += 3;
          teams[match.team_away].lost++;
        } else if (match.score_home < match.score_away) {
          teams[match.team_away].won++;
          teams[match.team_away].points += 3;
          teams[match.team_home].lost++;
        } else {
          teams[match.team_home].drawn++;
          teams[match.team_away].drawn++;
          teams[match.team_home].points++;
          teams[match.team_away].points++;
        }
      });

      // Trier chaque poule
      const sortedStandings = {};
      for (const [poule, teams] of Object.entries(pouleStandings)) {
        sortedStandings[poule] = Object.values(teams).sort((a, b) => {
          if (b.points !== a.points) return b.points - a.points;
          const diffA = a.goalsFor - a.goalsAgainst;
          const diffB = b.goalsFor - b.goalsAgainst;
          if (diffB !== diffA) return diffB - diffA;
          return b.goalsFor - a.goalsFor;
        });
      }

      return sortedStandings;
    }

    function handleGenerateFinalsPhase() {
      const btn = document.getElementById('generate-finals-btn');
      
      // V√©rifier si toutes les poules ont des classements
      const standings = getPouleStandings();
      
      const missingPoules = [];
      ['Poule A', 'Poule B', 'Poule C', 'Poule D'].forEach(poule => {
        if (!standings[poule] || standings[poule].length < 4) {
          missingPoules.push(poule);
        }
      });

      if (missingPoules.length > 0) {
        showNotification(`Les poules suivantes n'ont pas de classement complet: ${missingPoules.join(', ')}`, 'error');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'G√©n√©ration en cours...';

      // R√©cup√©rer les √©quipes class√©es
      const team1A = standings['Poule A'][0].name;
      const team2A = standings['Poule A'][1].name;
      const team3A = standings['Poule A'][2].name;
      const team4A = standings['Poule A'][3].name;

      const team1B = standings['Poule B'][0].name;
      const team2B = standings['Poule B'][1].name;
      const team3B = standings['Poule B'][2].name;
      const team4B = standings['Poule B'][3].name;

      const team1C = standings['Poule C'][0].name;
      const team2C = standings['Poule C'][1].name;
      const team3C = standings['Poule C'][2].name;
      const team4C = standings['Poule C'][3].name;

      const team1D = standings['Poule D'][0].name;
      const team2D = standings['Poule D'][1].name;
      const team3D = standings['Poule D'][2].name;
      const team4D = standings['Poule D'][3].name;

      // Phase Finale 1 - 13h40 (8 matches espac√©s de 10min)
      const phase1Matches = [
        { home: team3A, away: team4C, label: 'M1', time: '13:40' },
        { home: team3B, away: team4D, label: 'M2', time: '13:50' },
        { home: team3C, away: team4A, label: 'M3', time: '14:00' },
        { home: team3D, away: team4B, label: 'M4', time: '14:10' },
        { home: team1A, away: team2C, label: 'M5', time: '14:20' },
        { home: team1B, away: team2D, label: 'M6', time: '14:30' },
        { home: team1C, away: team2A, label: 'M7', time: '14:40' },
        { home: team1D, away: team2B, label: 'M8', time: '14:50' }
      ];

      phase1Matches.forEach(match => {
        const today = new Date();
        const [hours, minutes] = match.time.split(':');
        today.setHours(parseInt(hours), parseInt(minutes), 0, 0);

        const newMatch = {
          __backendId: `${match.label}_${Date.now()}_${Math.random()}`,
          match_id: match.label,
          team_home: match.home,
          team_away: match.away,
          score_home: 0,
          score_away: 0,
          date: today.toISOString(),
          is_finished: false,
          poule: 'Phase Finale 1'
        };

        allMatches.push(newMatch);
      });

      // Phase Finale 2 - Matches d√©pendant des r√©sultats (8 matches)
      const phase2Matches = [
        { home: 'Perdant M1', away: 'Perdant M2', label: 'M9', description: 'Perdants M1-M2', time: '15:00' },
        { home: 'Vainqueur M1', away: 'Vainqueur M2', label: 'M10', description: 'Vainqueurs M1-M2', time: '15:10' },
        { home: 'Perdant M3', away: 'Perdant M4', label: 'M11', description: 'Perdants M3-M4', time: '15:20' },
        { home: 'Vainqueur M3', away: 'Vainqueur M4', label: 'M12', description: 'Vainqueurs M3-M4', time: '15:30' },
        { home: 'Perdant M5', away: 'Perdant M6', label: 'M13', description: 'Perdants M5-M6', time: '15:40' },
        { home: 'Perdant M7', away: 'Perdant M8', label: 'M14', description: 'Perdants M7-M8', time: '15:50' },
        { home: 'Vainqueur M5', away: 'Vainqueur M6', label: 'M15', description: 'Vainqueurs M5-M6', time: '16:00' },
        { home: 'Vainqueur M7', away: 'Vainqueur M8', label: 'M16', description: 'Vainqueurs M7-M8', time: '16:10' }
      ];

      phase2Matches.forEach(match => {
        const today = new Date();
        const [hours, minutes] = match.time.split(':');
        today.setHours(parseInt(hours), parseInt(minutes), 0, 0);

        const newMatch = {
          __backendId: `${match.label}_${Date.now()}_${Math.random()}`,
          match_id: match.label,
          match_description: match.description,
          team_home: match.home,
          team_away: match.away,
          score_home: 0,
          score_away: 0,
          date: today.toISOString(),
          is_finished: false,
          poule: 'Phase Finale 2'
        };

        allMatches.push(newMatch);
      });

      // Matchs de Classement (8 matches) - avec r√©solution automatique des √©quipes
      const classementMatches = [
        { home: 'Perdant M9', away: 'Perdant M11', label: 'M17', description: '15/16√®me place', time: '16:20' },
        { home: 'Vainqueur M9', away: 'Vainqueur M11', label: 'M18', description: '13/14√®me place', time: '16:30' },
        { home: 'Perdant M10', away: 'Perdant M12', label: 'M19', description: '11/12√®me place', time: '16:40' },
        { home: 'Vainqueur M10', away: 'Vainqueur M12', label: 'M20', description: '9/10√®me place', time: '16:50' },
        { home: 'Perdant M13', away: 'Perdant M14', label: 'M21', description: '7/8√®me place', time: '17:00' },
        { home: 'Vainqueur M13', away: 'Vainqueur M14', label: 'M22', description: '5/6√®me place', time: '17:10' },
        { home: 'Perdant M15', away: 'Perdant M16', label: 'M23', description: '3/4√®me place', time: '17:20' },
        { home: 'Vainqueur M15', away: 'Vainqueur M16', label: 'M24', description: 'FINALE 1√®re/2√®me place', time: '17:30' }
      ];

      classementMatches.forEach(match => {
        const today = new Date();
        const [hours, minutes] = match.time.split(':');
        today.setHours(parseInt(hours), parseInt(minutes), 0, 0);

        const newMatch = {
          __backendId: `${match.label}_${Date.now()}_${Math.random()}`,
          match_id: match.label,
          match_description: match.description,
          team_home: match.home,
          team_away: match.away,
          score_home: 0,
          score_away: 0,
          date: today.toISOString(),
          is_finished: false,
          poule: 'Matchs de Classement'
        };

        allMatches.push(newMatch);
      });

      saveToLocalStorage();
      renderMatches();
      updateGenerateButtonsState();

      btn.disabled = false;
      btn.textContent = 'üèÜ G√©n√©rer les phases finales (apr√®s les poules)';

      showNotification(`24 matches de phases finales cr√©√©s avec succ√®s !`, 'success');
    }

    function init() {
      loadFromLocalStorage();
      setupEventListeners();
    }

    function setupEventListeners() {
      document.getElementById('login-btn').addEventListener('click', handleLogin);
      document.getElementById('logout-btn').addEventListener('click', handleLogout);
      document.getElementById('add-match-form').addEventListener('submit', handleAddMatch);
      document.getElementById('poule-filter').addEventListener('change', handlePouleFilterChange);
      document.getElementById('generate-all-matches-btn').addEventListener('click', handleGenerateAllMatches);
      document.getElementById('generate-finals-btn').addEventListener('click', handleGenerateFinalsPhase);
      document.getElementById('reset-tournament-btn').addEventListener('click', handleResetTournament);
      
      updateGenerateButtonsState();
      
      document.getElementById('password-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          handleLogin();
        }
      });
      
      document.getElementById('poule-select').addEventListener('change', (e) => {
        const poule = e.target.value;
        const teamHomeSelect = document.getElementById('team-home');
        const teamAwaySelect = document.getElementById('team-away');
        
        teamHomeSelect.innerHTML = '<option value="">Choisir l\'√©quipe</option>';
        teamAwaySelect.innerHTML = '<option value="">Choisir l\'√©quipe</option>';
        
        if (poule && POULES[poule]) {
          POULES[poule].forEach(team => {
            const optionHome = document.createElement('option');
            optionHome.value = team;
            optionHome.textContent = team;
            teamHomeSelect.appendChild(optionHome);
            
            const optionAway = document.createElement('option');
            optionAway.value = team;
            optionAway.textContent = team;
            teamAwaySelect.appendChild(optionAway);
          });
        } else if (poule) {
          // Pour les phases finales, permettre de choisir toutes les √©quipes
          Object.keys(TEAMS).forEach(team => {
            const optionHome = document.createElement('option');
            optionHome.value = team;
            optionHome.textContent = team;
            teamHomeSelect.appendChild(optionHome);
            
            const optionAway = document.createElement('option');
            optionAway.value = team;
            optionAway.textContent = team;
            teamAwaySelect.appendChild(optionAway);
          });
        }
      });
    }

    function updateGenerateButtonsState() {
      const generatePoolsBtn = document.getElementById('generate-all-matches-btn');
      const generateFinalsBtn = document.getElementById('generate-finals-btn');
      
      // V√©rifier si des matches de poules existent d√©j√†
      const poolsGenerated = allMatches.some(m => 
        m.poule === 'Poule A' || m.poule === 'Poule B' || 
        m.poule === 'Poule C' || m.poule === 'Poule D'
      );
      
      // V√©rifier si des phases finales existent d√©j√†
      const finalsGenerated = allMatches.some(m => 
        m.poule === 'Phase Finale 1' || m.poule === 'Phase Finale 2' || 
        m.poule === 'Matchs de Classement'
      );
      
      if (poolsGenerated) {
        generatePoolsBtn.disabled = true;
        generatePoolsBtn.textContent = '‚úÖ Matches de poules d√©j√† g√©n√©r√©s';
      } else {
        generatePoolsBtn.disabled = false;
        generatePoolsBtn.textContent = '‚ö° G√©n√©rer tous les matches de poules (Planning optimis√© 9h00-13h30)';
      }
      
      if (finalsGenerated) {
        generateFinalsBtn.disabled = true;
        generateFinalsBtn.textContent = '‚úÖ Phases finales d√©j√† g√©n√©r√©es';
      } else {
        generateFinalsBtn.disabled = false;
        generateFinalsBtn.textContent = 'üèÜ G√©n√©rer les phases finales (apr√®s les poules)';
      }
    }

    function handleResetTournament() {
      const btn = document.getElementById('reset-tournament-btn');
      const originalText = btn.textContent;
      
      btn.textContent = '‚ö†Ô∏è Confirmer la suppression ?';
      btn.classList.remove('bg-red-600', 'hover:bg-red-700');
      btn.classList.add('bg-orange-600', 'hover:bg-orange-700');
      
      const confirmReset = () => {
        allMatches = [];
        tournamentFinalized = false;
        saveToLocalStorage();
        renderMatches();
        updateStandings();
        updateGenerateButtonsState();
        showNotification('üóëÔ∏è Tous les matches ont √©t√© supprim√©s', 'success');
        btn.textContent = originalText;
        btn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
        btn.classList.add('bg-red-600', 'hover:bg-red-700');
        btn.removeEventListener('click', confirmReset);
      };
      
      const cancelReset = () => {
        btn.textContent = originalText;
        btn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
        btn.classList.add('bg-red-600', 'hover:bg-red-700');
        btn.removeEventListener('click', confirmReset);
        document.removeEventListener('click', outsideClickHandler);
      };
      
      const outsideClickHandler = (event) => {
        if (event.target !== btn) {
          cancelReset();
        }
      };
      
      setTimeout(() => {
        btn.addEventListener('click', confirmReset, { once: true });
        document.addEventListener('click', outsideClickHandler, { once: true });
      }, 100);
    }

    function handleGenerateAllMatches() {
      const btn = document.getElementById('generate-all-matches-btn');

      btn.disabled = true;
      btn.textContent = 'G√©n√©ration en cours...';

      // Planning optimis√© sur 4h30 (9h00 - 13h30)
      // Repos √©quilibr√© : min 40min, max 2h
      const matchSchedule = [
        // 9h00 - 10h10 (7 matches)
        { time: '09:00', poule: 'Poule A', home: 'Chelles 1', away: 'Claye Souilly Sports' },
        { time: '09:10', poule: 'Poule B', home: 'Chelles 2', away: 'FC Gagny' },
        { time: '09:20', poule: 'Poule C', home: 'Chelles 3', away: 'US Vaires' },
        { time: '09:30', poule: 'Poule D', home: 'Chelles 4', away: 'US Torcy PVM' },
        { time: '09:40', poule: 'Poule A', home: 'Esp√©rance Aulnaysienne', away: 'Entente SSG' },
        { time: '09:50', poule: 'Poule B', home: 'Red Star FC', away: 'US Fontenay' },
        { time: '10:00', poule: 'Poule C', home: 'Noisy le Grand FC', away: 'AS La Courneuve' },
        
        // 10h10 - 11h20 (7 matches)
        { time: '10:10', poule: 'Poule D', home: 'RC Gonnesse', away: 'RC Joinville' },
        { time: '10:20', poule: 'Poule A', home: 'Claye Souilly Sports', away: 'Entente SSG' },
        { time: '10:30', poule: 'Poule B', home: 'FC Gagny', away: 'Red Star FC' },
        { time: '10:40', poule: 'Poule C', home: 'US Vaires', away: 'Noisy le Grand FC' },
        { time: '10:50', poule: 'Poule D', home: 'US Torcy PVM', away: 'RC Gonnesse' },
        { time: '11:00', poule: 'Poule A', home: 'Chelles 1', away: 'Entente SSG' },
        { time: '11:10', poule: 'Poule B', home: 'Chelles 2', away: 'Red Star FC' },
        
        // 11h20 - 12h30 (7 matches)
        { time: '11:20', poule: 'Poule C', home: 'Chelles 3', away: 'Noisy le Grand FC' },
        { time: '11:30', poule: 'Poule D', home: 'Chelles 4', away: 'RC Joinville' },
        { time: '11:40', poule: 'Poule A', home: 'Esp√©rance Aulnaysienne', away: 'Claye Souilly Sports' },
        { time: '11:50', poule: 'Poule B', home: 'FC Gagny', away: 'US Fontenay' },
        { time: '12:00', poule: 'Poule C', home: 'US Vaires', away: 'AS La Courneuve' },
        { time: '12:10', poule: 'Poule D', home: 'US Torcy PVM', away: 'RC Joinville' },
        { time: '12:20', poule: 'Poule A', home: 'Chelles 1', away: 'Esp√©rance Aulnaysienne' },
        
        // 12h30 - 13h30 (3 matches)
        { time: '12:30', poule: 'Poule B', home: 'Chelles 2', away: 'US Fontenay' },
        { time: '12:40', poule: 'Poule C', home: 'Chelles 3', away: 'AS La Courneuve' },
        { time: '12:50', poule: 'Poule D', home: 'Chelles 4', away: 'RC Gonnesse' }
      ];

      matchSchedule.forEach((matchDef, i) => {
        const today = new Date();
        const [hours, minutes] = matchDef.time.split(':');
        today.setHours(parseInt(hours), parseInt(minutes), 0, 0);

        const newMatch = {
          __backendId: `match_${Date.now()}_${i}_${Math.random()}`,
          match_id: `match_${Date.now()}_${i}`,
          team_home: matchDef.home,
          team_away: matchDef.away,
          score_home: 0,
          score_away: 0,
          date: today.toISOString(),
          is_finished: false,
          poule: matchDef.poule
        };

        allMatches.push(newMatch);
      });

      saveToLocalStorage();
      renderMatches();
      updateStandings();
      updateGenerateButtonsState();

      btn.disabled = false;
      btn.textContent = '‚ö° G√©n√©rer tous les matches de poules (Planning optimis√© 9h00-13h30)';

      showNotification(`${matchSchedule.length} matches cr√©√©s avec succ√®s ! Planning optimis√© 9h00-13h30`, 'success');
    }

    function handlePouleFilterChange(e) {
      selectedPoule = e.target.value;
      renderMatches();
      updateStandings();
    }

    function handleLogin() {
      const passwordInput = document.getElementById('password-input');
      const password = passwordInput.value;
      const errorMsg = document.getElementById('login-error');

      if (password === ADMIN_PASSWORD) {
        isAdmin = true;
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('admin-status').classList.remove('hidden');
        document.getElementById('add-match-section').classList.remove('hidden');
        errorMsg.classList.add('hidden');
        passwordInput.value = '';
        renderMatches();
      } else {
        errorMsg.textContent = '‚ùå Mot de passe incorrect';
        errorMsg.classList.remove('hidden');
        passwordInput.value = '';
      }
    }

    function handleLogout() {
      isAdmin = false;
      document.getElementById('login-form').classList.remove('hidden');
      document.getElementById('admin-status').classList.add('hidden');
      document.getElementById('add-match-section').classList.add('hidden');
      document.getElementById('login-error').classList.add('hidden');
      renderMatches();
    }

    function handleAddMatch(e) {
      e.preventDefault();

      const poule = document.getElementById('poule-select').value;
      const teamHome = document.getElementById('team-home').value;
      const teamAway = document.getElementById('team-away').value;
      const matchTime = document.getElementById('match-time').value;

      if (teamHome === teamAway) {
        showNotification('Les deux √©quipes doivent √™tre diff√©rentes', 'error');
        return;
      }

      const today = new Date();
      const [hours, minutes] = matchTime.split(':');
      today.setHours(parseInt(hours), parseInt(minutes), 0, 0);

      const newMatch = {
        __backendId: `match_${Date.now()}`,
        match_id: `match_${Date.now()}`,
        team_home: teamHome,
        team_away: teamAway,
        score_home: 0,
        score_away: 0,
        date: today.toISOString(),
        is_finished: false,
        poule: poule
      };

      allMatches.push(newMatch);
      saveToLocalStorage();
      renderMatches();
      updateStandings();
      updateGenerateButtonsState();
      
      e.target.reset();
      showNotification('Match cr√©√© avec succ√®s !', 'success');
    }

    function resolveTeamName(teamLabel, depth = 0) {
      // Protection contre la r√©cursion infinie
      if (depth > 10) return teamLabel;
      
      // Si c'est d√©j√† un nom d'√©quipe, le retourner
      if (TEAMS[teamLabel]) {
        return teamLabel;
      }

      // Si c'est un label comme "Vainqueur M1" ou "Perdant M2"
      const matchRef = teamLabel.match(/(Vainqueur|Perdant) M(\d+)/);
      if (!matchRef) return teamLabel;

      const isWinner = matchRef[1] === 'Vainqueur';
      const matchNum = matchRef[2];

      // Trouver le match r√©f√©renc√©
      const referencedMatch = allMatches.find(m => m.match_id === `M${matchNum}`);
      
      if (!referencedMatch || !referencedMatch.is_finished) {
        return teamLabel; // Match pas encore jou√©
      }

      let teamName;
      
      // V√©rifier d'abord s'il y a un d√©partage en cas d'√©galit√©
      if (referencedMatch.score_home === referencedMatch.score_away) {
        if (referencedMatch.tiebreaker_winner === 'home') {
          teamName = isWinner ? referencedMatch.team_home : referencedMatch.team_away;
        } else if (referencedMatch.tiebreaker_winner === 'away') {
          teamName = isWinner ? referencedMatch.team_away : referencedMatch.team_home;
        } else {
          // Pas de d√©partage d√©fini, retourner le label
          return teamLabel;
        }
      } else {
        // D√©terminer le vainqueur ou perdant par le score
        if (referencedMatch.score_home > referencedMatch.score_away) {
          teamName = isWinner ? referencedMatch.team_home : referencedMatch.team_away;
        } else {
          teamName = isWinner ? referencedMatch.team_away : referencedMatch.team_home;
        }
      }
      
      // R√©soudre r√©cursivement si le nom est encore un label
      return resolveTeamName(teamName, depth + 1);
    }

    function renderMatches() {
      const container = document.getElementById('matches-container');
      
      if (allMatches.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun match pour le moment. Connectez-vous en mode admin pour ajouter des matches.</p>';
        return;
      }

      const sortedMatches = [...allMatches].sort((a, b) => new Date(a.date) - new Date(b.date));
      
      const filteredMatches = selectedPoule === 'all' 
        ? sortedMatches 
        : sortedMatches.filter(match => match.poule === selectedPoule);

      if (filteredMatches.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun match pour cette phase.</p>';
        return;
      }

      container.innerHTML = filteredMatches.map(match => {
        const matchDate = new Date(match.date);
        const formattedDate = matchDate.toLocaleTimeString('fr-FR', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        
        // R√©soudre les noms d'√©quipes
        const resolvedTeamHome = resolveTeamName(match.team_home);
        const resolvedTeamAway = resolveTeamName(match.team_away);
        
        const logoHome = TEAMS[resolvedTeamHome] || '';
        const logoAway = TEAMS[resolvedTeamAway] || '';
        
        // Afficher la description du match si elle existe
        const matchDescription = match.match_description ? `<span class="text-xs font-semibold text-gray-600 bg-gray-100 px-2 py-1 rounded">${match.match_description}</span>` : '';

        return `
          <div class="match-card bg-gradient-to-r from-blue-50 to-green-50 rounded-xl p-6 border-2 border-gray-200" data-match-id="${match.__backendId}">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <span class="text-sm font-bold text-white bg-blue-600 px-3 py-1 rounded-lg">${match.poule}</span>
                ${match.match_id && !match.match_id.startsWith('match_') ? `<span class="text-xs font-bold text-purple-700 bg-purple-100 px-2 py-1 rounded">${match.match_id}</span>` : ''}
                ${matchDescription}
                <span class="text-sm font-semibold text-gray-600">üìÖ ${formattedDate}</span>
              </div>
              ${match.is_finished ? '<span class="px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full">TERMIN√â</span>' : '<span class="px-3 py-1 bg-yellow-500 text-white text-xs font-bold rounded-full">EN COURS</span>'}
            </div>
            
            <div class="flex items-center justify-between gap-4">
              <div class="flex-1 text-right flex flex-col items-end gap-2">
                <div class="flex items-center justify-end gap-3">
                  ${isAdmin && match.score_home === match.score_away && match.score_home > 0 ? `
                    <div class="flex items-center gap-2 bg-yellow-100 px-2 py-1 rounded">
                      <input 
                        type="checkbox" 
                        id="tiebreaker-home-${match.__backendId}"
                        class="w-5 h-5 cursor-pointer tiebreaker-checkbox"
                        data-match-id="${match.__backendId}"
                        data-team="home"
                        ${match.tiebreaker_winner === 'home' ? 'checked' : ''}
                        onchange="handleTiebreakerChange(this)"
                      />
                      <label for="tiebreaker-home-${match.__backendId}" class="text-xs font-bold text-yellow-800 cursor-pointer">Vainqueur d√©partage</label>
                    </div>
                  ` : ''}
                  <h3 class="text-xl font-bold text-gray-800">${resolvedTeamHome}</h3>
                  ${logoHome ? `<img src="${logoHome}" alt="${resolvedTeamHome}" class="w-12 h-12 object-contain" onerror="this.style.display='none';" />` : ''}
                </div>
              </div>
              
              <div class="flex items-center gap-4">
                ${isAdmin ? `
                  <input 
                    type="text" 
                    inputmode="numeric"
                    pattern="[0-9]*"
                    value="${match.score_home}" 
                    class="score-input border-2 border-blue-400 rounded-lg py-2 focus:outline-none focus:border-blue-600"
                    data-match-id="${match.__backendId}"
                    data-team="home"
                    onchange="handleScoreChange(this)"
                    oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                    onfocus="this.select()"
                    onkeypress="handleScoreKeypress(event, this)"
                  />
                ` : `
                  <div class="score-input bg-blue-600 text-white rounded-lg py-2 flex items-center justify-center font-bold">${match.score_home}</div>
                `}
                
                <span class="text-2xl font-bold text-gray-400">-</span>
                
                ${isAdmin ? `
                  <input 
                    type="text" 
                    inputmode="numeric"
                    pattern="[0-9]*"
                    value="${match.score_away}" 
                    class="score-input border-2 border-green-400 rounded-lg py-2 focus:outline-none focus:border-green-600"
                    data-match-id="${match.__backendId}"
                    data-team="away"
                    onchange="handleScoreChange(this)"
                    oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                    onfocus="this.select()"
                    onkeypress="handleScoreKeypress(event, this)"
                  />
                ` : `
                  <div class="score-input bg-green-600 text-white rounded-lg py-2 flex items-center justify-center font-bold">${match.score_away}</div>
                `}
              </div>
              
              <div class="flex-1 flex flex-col items-start gap-2">
                <div class="flex items-center gap-3">
                  ${logoAway ? `<img src="${logoAway}" alt="${resolvedTeamAway}" class="w-12 h-12 object-contain" onerror="this.style.display='none';" />` : ''}
                  <h3 class="text-xl font-bold text-gray-800">${resolvedTeamAway}</h3>
                  ${isAdmin && match.score_home === match.score_away && match.score_home > 0 ? `
                    <div class="flex items-center gap-2 bg-yellow-100 px-2 py-1 rounded">
                      <input 
                        type="checkbox" 
                        id="tiebreaker-away-${match.__backendId}"
                        class="w-5 h-5 cursor-pointer tiebreaker-checkbox"
                        data-match-id="${match.__backendId}"
                        data-team="away"
                        ${match.tiebreaker_winner === 'away' ? 'checked' : ''}
                        onchange="handleTiebreakerChange(this)"
                      />
                      <label for="tiebreaker-away-${match.__backendId}" class="text-xs font-bold text-yellow-800 cursor-pointer">Vainqueur d√©partage</label>
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>
            
            ${isAdmin ? `
              <div class="mt-4 pt-4 border-t border-gray-300 flex gap-3 flex-wrap">
                <button 
                  class="save-match-btn flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                  data-match-id="${match.__backendId}"
                >
                  üíæ Enregistrer les Scores
                </button>
                <button 
                  class="edit-teams-btn px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors"
                  data-match-id="${match.__backendId}"
                >
                  ‚úèÔ∏è Modifier √âquipes
                </button>
                <button 
                  class="toggle-finished-btn px-4 py-2 ${match.is_finished ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-600 hover:bg-green-700'} text-white rounded-lg font-semibold transition-colors"
                  data-match-id="${match.__backendId}"
                >
                  ${match.is_finished ? 'üîÑ Rouvrir' : '‚úÖ Terminer'}
                </button>
                <button 
                  class="delete-match-btn px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors"
                  data-match-id="${match.__backendId}"
                >
                  ‚ùå Supprimer
                </button>
              </div>
              
              <div class="edit-teams-form hidden mt-4 pt-4 border-t border-gray-300" data-match-id="${match.__backendId}">
                <h4 class="font-bold text-gray-700 mb-3">Modifier les √©quipes :</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">√âquipe Domicile</label>
                    <select class="edit-team-home w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                      ${Object.keys(TEAMS).map(team => 
                        `<option value="${team}" ${team === match.team_home ? 'selected' : ''}>${team}</option>`
                      ).join('')}
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">√âquipe Ext√©rieur</label>
                    <select class="edit-team-away w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                      ${Object.keys(TEAMS).map(team => 
                        `<option value="${team}" ${team === match.team_away ? 'selected' : ''}>${team}</option>`
                      ).join('')}
                    </select>
                  </div>
                </div>
                <div class="flex gap-3">
                  <button 
                    class="save-teams-btn flex-1 px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors"
                    data-match-id="${match.__backendId}"
                  >
                    ‚úÖ Enregistrer les Modifications
                  </button>
                  <button 
                    class="cancel-edit-btn px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition-colors"
                    data-match-id="${match.__backendId}"
                  >
                    ‚ùå Annuler
                  </button>
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');

      if (isAdmin) {
        document.querySelectorAll('.save-match-btn').forEach(btn => {
          btn.addEventListener('click', handleSaveMatch);
        });
        document.querySelectorAll('.toggle-finished-btn').forEach(btn => {
          btn.addEventListener('click', handleToggleFinished);
        });
        document.querySelectorAll('.delete-match-btn').forEach(btn => {
          btn.addEventListener('click', handleDeleteMatch);
        });
        document.querySelectorAll('.edit-teams-btn').forEach(btn => {
          btn.addEventListener('click', handleEditTeams);
        });
        document.querySelectorAll('.cancel-edit-btn').forEach(btn => {
          btn.addEventListener('click', handleCancelEdit);
        });
        document.querySelectorAll('.save-teams-btn').forEach(btn => {
          btn.addEventListener('click', handleSaveTeams);
        });
      }
    }

    function handleScoreChange(input) {
      const matchId = input.dataset.matchId;
      const match = allMatches.find(m => m.__backendId === matchId);
      if (!match) return;

      const card = input.closest('.match-card');
      const homeInput = card.querySelector('input[data-team="home"]');
      const awayInput = card.querySelector('input[data-team="away"]');

      match.score_home = parseInt(homeInput.value) || 0;
      match.score_away = parseInt(awayInput.value) || 0;

      saveToLocalStorage();
      renderMatches();
      updateStandings();
      showNotification('Score modifi√© !', 'success');
    }

    function handleTiebreakerChange(checkbox) {
      const matchId = checkbox.dataset.matchId;
      const team = checkbox.dataset.team;
      const match = allMatches.find(m => m.__backendId === matchId);
      if (!match) return;

      // D√©cocher l'autre case
      const card = checkbox.closest('.match-card');
      const otherTeam = team === 'home' ? 'away' : 'home';
      const otherCheckbox = card.querySelector(`.tiebreaker-checkbox[data-team="${otherTeam}"]`);
      
      if (checkbox.checked) {
        match.tiebreaker_winner = team;
        if (otherCheckbox) {
          otherCheckbox.checked = false;
        }
      } else {
        match.tiebreaker_winner = null;
      }

      saveToLocalStorage();
      renderMatches();
      updateStandings();
      showNotification('Vainqueur du d√©partage enregistr√© !', 'success');
    }

    window.handleTiebreakerChange = handleTiebreakerChange;

    function handleScoreKeypress(event, input) {
      if (event.key === 'Enter') {
        event.preventDefault();
        
        const matchId = input.dataset.matchId;
        const match = allMatches.find(m => m.__backendId === matchId);
        if (!match) return;

        const card = input.closest('.match-card');
        const homeInput = card.querySelector('input[data-team="home"]');
        const awayInput = card.querySelector('input[data-team="away"]');

        // Sauvegarder les scores
        match.score_home = parseInt(homeInput.value) || 0;
        match.score_away = parseInt(awayInput.value) || 0;
        
        // Terminer le match
        match.is_finished = true;

        saveToLocalStorage();
        renderMatches();
        updateStandings();
        
        showNotification('Match termin√© et scores enregistr√©s ! ‚úÖ', 'success');
        
        // Retirer le focus de l'input
        input.blur();
      }
    }
    
    window.handleScoreKeypress = handleScoreKeypress;

    function handleSaveMatch(e) {
      const matchId = e.target.dataset.matchId;
      const match = allMatches.find(m => m.__backendId === matchId);
      if (!match) return;

      const card = e.target.closest('.match-card');
      const homeInput = card.querySelector('input[data-team="home"]');
      const awayInput = card.querySelector('input[data-team="away"]');

      match.score_home = parseInt(homeInput.value) || 0;
      match.score_away = parseInt(awayInput.value) || 0;

      saveToLocalStorage();
      updateStandings();
      
      showNotification('Scores enregistr√©s !', 'success');
    }
    
    window.handleScoreChange = handleScoreChange;
    window.handleScoreKeypress = handleScoreKeypress;

    function handleToggleFinished(e) {
      const matchId = e.target.dataset.matchId;
      const match = allMatches.find(m => m.__backendId === matchId);
      if (!match) return;

      match.is_finished = !match.is_finished;

      saveToLocalStorage();
      renderMatches();
      updateStandings();
      
      showNotification(match.is_finished ? 'Match termin√©' : 'Match rouvert', 'success');
    }

    function handleDeleteMatch(e) {
      const matchId = e.target.dataset.matchId;
      const matchIndex = allMatches.findIndex(m => m.__backendId === matchId);
      if (matchIndex === -1) return;

      const card = e.target.closest('.match-card');
      const originalHTML = e.target.innerHTML;
      
      e.target.innerHTML = 'Confirmer?';
      e.target.classList.remove('bg-red-600', 'hover:bg-red-700');
      e.target.classList.add('bg-orange-600', 'hover:bg-orange-700');
      
      const confirmDelete = () => {
        allMatches.splice(matchIndex, 1);
        saveToLocalStorage();
        renderMatches();
        updateStandings();
        updateGenerateButtonsState();
        showNotification('Match supprim√©', 'success');
        e.target.removeEventListener('click', confirmDelete);
      };
      
      const cancelDelete = () => {
        e.target.innerHTML = originalHTML;
        e.target.classList.remove('bg-orange-600', 'hover:bg-orange-700');
        e.target.classList.add('bg-red-600', 'hover:bg-red-700');
        e.target.removeEventListener('click', confirmDelete);
        document.removeEventListener('click', outsideClickHandler);
      };
      
      const outsideClickHandler = (event) => {
        if (!card.contains(event.target)) {
          cancelDelete();
        }
      };
      
      setTimeout(() => {
        e.target.addEventListener('click', confirmDelete);
        document.addEventListener('click', outsideClickHandler);
      }, 100);
    }

    function handleEditTeams(e) {
      const matchId = e.target.dataset.matchId;
      const card = document.querySelector(`.match-card[data-match-id="${matchId}"]`);
      const editForm = card.querySelector(`.edit-teams-form[data-match-id="${matchId}"]`);
      
      if (editForm) {
        editForm.classList.toggle('hidden');
      }
    }

    function handleCancelEdit(e) {
      const matchId = e.target.dataset.matchId;
      const card = document.querySelector(`.match-card[data-match-id="${matchId}"]`);
      const editForm = card.querySelector(`.edit-teams-form[data-match-id="${matchId}"]`);
      
      if (editForm) {
        editForm.classList.add('hidden');
      }
    }

    function handleSaveTeams(e) {
      const matchId = e.target.dataset.matchId;
      const match = allMatches.find(m => m.__backendId === matchId);
      if (!match) return;

      const card = document.querySelector(`.match-card[data-match-id="${matchId}"]`);
      const editForm = card.querySelector(`.edit-teams-form[data-match-id="${matchId}"]`);
      const teamHomeSelect = editForm.querySelector('.edit-team-home');
      const teamAwaySelect = editForm.querySelector('.edit-team-away');

      const newTeamHome = teamHomeSelect.value;
      const newTeamAway = teamAwaySelect.value;

      if (newTeamHome === newTeamAway) {
        showNotification('Les deux √©quipes doivent √™tre diff√©rentes', 'error');
        return;
      }

      match.team_home = newTeamHome;
      match.team_away = newTeamAway;

      saveToLocalStorage();
      renderMatches();
      
      showNotification('√âquipes modifi√©es avec succ√®s !', 'success');
      editForm.classList.add('hidden');
    }

    function getFinalStandings() {
      // R√©cup√©rer tous les matches de classement termin√©s
      const classementMatches = allMatches.filter(m => 
        m.poule === 'Matchs de Classement' && m.is_finished
      );

      const finalRankings = {};

      classementMatches.forEach(match => {
        let homeTeam = resolveTeamName(match.team_home);
        let awayTeam = resolveTeamName(match.team_away);
        
        // Si les √©quipes ne sont pas encore d√©termin√©es, ignorer ce match
        if (!TEAMS[homeTeam] || !TEAMS[awayTeam]) return;

        const description = match.match_description || '';
        
        // *** CORRECTION ICI - G√©rer sp√©cifiquement le cas "1√®re/2√®me" ***
        let betterPlace, worsePlace;
        
        if (description.includes('1√®re/2√®me')) {
          betterPlace = 1;
          worsePlace = 2;
        } else {
          // Pour les autres formats (15/16√®me, 3/4√®me, etc.)
          const placeMatch = description.match(/(\d+)\/(\d+)/);
          if (!placeMatch) return;
          betterPlace = parseInt(placeMatch[1]);
          worsePlace = parseInt(placeMatch[2]);
        }

        // D√©terminer le vainqueur et le perdant
        let winner, loser;
        
        if (match.score_home === match.score_away) {
          // En cas d'√©galit√©, utiliser le d√©partage
          if (match.tiebreaker_winner === 'home') {
            winner = homeTeam;
            loser = awayTeam;
          } else if (match.tiebreaker_winner === 'away') {
            winner = awayTeam;
            loser = homeTeam;
          } else {
            // Pas de d√©partage, ignorer ce match
            return;
          }
        } else if (match.score_home > match.score_away) {
          winner = homeTeam;
          loser = awayTeam;
        } else {
          winner = awayTeam;
          loser = homeTeam;
        }
        
        finalRankings[winner] = { place: betterPlace, team: winner };
        finalRankings[loser] = { place: worsePlace, team: loser };
      });

      // Calculer les statistiques compl√®tes du tournoi pour chaque √©quipe
      const teamStats = {};
      
      allMatches.forEach(match => {
        if (!match.is_finished) return;
        
        let homeTeam = resolveTeamName(match.team_home);
        let awayTeam = resolveTeamName(match.team_away);
        
        if (!TEAMS[homeTeam] || !TEAMS[awayTeam]) return;
        
        if (!teamStats[homeTeam]) {
          teamStats[homeTeam] = { goalsFor: 0, goalsAgainst: 0 };
        }
        if (!teamStats[awayTeam]) {
          teamStats[awayTeam] = { goalsFor: 0, goalsAgainst: 0 };
        }
        
        teamStats[homeTeam].goalsFor += match.score_home;
        teamStats[homeTeam].goalsAgainst += match.score_away;
        teamStats[awayTeam].goalsFor += match.score_away;
        teamStats[awayTeam].goalsAgainst += match.score_home;
      });
      
      // Ajouter les stats aux classements finaux
      Object.keys(finalRankings).forEach(team => {
        if (teamStats[team]) {
          finalRankings[team].goalsFor = teamStats[team].goalsFor;
          finalRankings[team].goalsAgainst = teamStats[team].goalsAgainst;
          finalRankings[team].goalDiff = teamStats[team].goalsFor - teamStats[team].goalsAgainst;
        }
      });

      return Object.values(finalRankings).sort((a, b) => a.place - b.place);
    }

    function updateStandings() {
      const standingsContainer = document.getElementById('standings-container');
      
      const pouleStandings = getPouleStandings();
      const finalStandings = getFinalStandings();

      const poulesToDisplay = selectedPoule === 'all' 
        ? Object.keys(pouleStandings).sort() 
        : (pouleStandings[selectedPoule] ? [selectedPoule] : []);

      if (poulesToDisplay.length === 0 && finalStandings.length === 0) {
        standingsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun r√©sultat pour le moment</p>';
        return;
      }

      let html = '';

      // Afficher le classement final en premier si disponible
      if (finalStandings.length > 0 && (selectedPoule === 'all' || selectedPoule === 'Matchs de Classement')) {
        html += `
          <div class="mb-8">
            <h3 class="text-2xl font-bold text-white mb-4 bg-gradient-to-r from-yellow-500 to-orange-500 px-6 py-4 rounded-lg shadow-lg">
              üèÜ CLASSEMENT FINAL DU TOURNOI üèÜ
            </h3>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b-2 border-gray-200 bg-gray-50">
                    <th class="text-left py-3 px-4 font-bold text-gray-700 text-base">Place</th>
                    <th class="text-left py-3 px-4 font-bold text-gray-700 text-base">√âquipe</th>
                    <th class="text-center py-3 px-4 font-bold text-gray-700 text-base">BP</th>
                    <th class="text-center py-3 px-4 font-bold text-gray-700 text-base">BC</th>
                    <th class="text-center py-3 px-4 font-bold text-gray-700 text-base">Diff</th>
                  </tr>
                </thead>
                <tbody>
                  ${finalStandings.map((ranking) => {
                    const logo = TEAMS[ranking.team] || '';
                    let positionColor = '';
                    let medal = '';
                    let suffix = '√®me';
                    
                    if (ranking.place === 1) {
                      positionColor = 'bg-yellow-100 border-l-4 border-yellow-500';
                      medal = 'ü•á';
                      suffix = '√®re';
                    } else if (ranking.place === 2) {
                      positionColor = 'bg-gray-100 border-l-4 border-gray-400';
                      medal = 'ü•à';
                    } else if (ranking.place === 3) {
                      positionColor = 'bg-orange-100 border-l-4 border-orange-500';
                      medal = 'ü•â';
                    }
                    
                    const goalsFor = ranking.goalsFor || 0;
                    const goalsAgainst = ranking.goalsAgainst || 0;
                    const goalDiff = ranking.goalDiff || 0;
                    const diffDisplay = goalDiff > 0 ? `+${goalDiff}` : goalDiff;
                    
                    return `
                      <tr class="${positionColor} border-b border-gray-100">
                        <td class="py-4 px-4 font-bold text-gray-800 text-lg">${medal} ${ranking.place}${suffix}</td>
                        <td class="py-4 px-4">
                          <div class="flex items-center gap-4">
                            <img src="${logo}" alt="${ranking.team}" class="w-16 h-16 object-contain flex-shrink-0" onerror="this.style.display='none';" />
                            <span class="font-bold text-gray-800 text-lg">${ranking.team}</span>
                          </div>
                        </td>
                        <td class="py-4 px-4 text-center font-bold text-green-700 text-base">${goalsFor}</td>
                        <td class="py-4 px-4 text-center font-bold text-red-700 text-base">${goalsAgainst}</td>
                        <td class="py-4 px-4 text-center font-bold text-base ${goalDiff > 0 ? 'text-green-700' : goalDiff < 0 ? 'text-red-700' : 'text-gray-600'}">${diffDisplay}</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      // Afficher les classements de poules
      html += poulesToDisplay.map(poule => {
        const standings = pouleStandings[poule];

        return `
          <div class="mb-8">
            <h3 class="text-xl font-bold text-blue-900 mb-3 bg-blue-100 px-4 py-2 rounded-lg">${poule}</h3>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b-2 border-gray-200">
                    <th class="text-left py-3 px-2 font-bold text-gray-700 text-sm">Pos</th>
                    <th class="text-left py-3 px-2 font-bold text-gray-700 text-sm">√âquipe</th>
                    <th class="text-center py-3 px-2 font-bold text-gray-700 text-sm">J</th>
                    <th class="text-center py-3 px-2 font-bold text-gray-700 text-sm">V</th>
                    <th class="text-center py-3 px-2 font-bold text-gray-700 text-sm">N</th>
                    <th class="text-center py-3 px-2 font-bold text-gray-700 text-sm">D</th>
                    <th class="text-center py-3 px-2 font-bold text-gray-700 text-sm">BP</th>
                    <th class="text-center py-3 px-2 font-bold text-gray-700 text-sm">BC</th>
                    <th class="text-center py-3 px-2 font-bold text-gray-700 text-sm">Diff</th>
                    <th class="text-center py-3 px-2 font-bold text-gray-700 text-sm">Pts</th>
                  </tr>
                </thead>
                <tbody>
                  ${standings.map((team, index) => {
                    const diff = team.goalsFor - team.goalsAgainst;
                    const diffDisplay = diff > 0 ? `+${diff}` : diff;
                    const positionColor = index === 0 ? 'bg-yellow-100' : index === 1 ? 'bg-gray-100' : '';
                    const logo = TEAMS[team.name] || '';
                    
                    return `
                      <tr class="${positionColor} border-b border-gray-100">
                        <td class="py-3 px-2 font-bold text-gray-800">${index + 1}</td>
                        <td class="py-3 px-2 min-w-[200px]">
                          <div class="flex items-center gap-3">
                            <img src="${logo}" alt="${team.name}" class="w-12 h-12 object-contain flex-shrink-0" onerror="this.style.display='none';" />
                            <span class="font-semibold text-gray-800 text-sm">${team.name}</span>
                          </div>
                        </td>
                        <td class="py-3 px-2 text-center text-sm">${team.played}</td>
                        <td class="py-3 px-2 text-center text-green-700 font-semibold text-sm">${team.won}</td>
                        <td class="py-3 px-2 text-center text-gray-600 text-sm">${team.drawn}</td>
                        <td class="py-3 px-2 text-center text-red-700 font-semibold text-sm">${team.lost}</td>
                        <td class="py-3 px-2 text-center font-semibold text-sm">${team.goalsFor}</td>
                        <td class="py-3 px-2 text-center font-semibold text-sm">${team.goalsAgainst}</td>
                        <td class="py-3 px-2 text-center font-bold text-sm ${diff > 0 ? 'text-green-700' : diff < 0 ? 'text-red-700' : 'text-gray-600'}">${diffDisplay}</td>
                        <td class="py-3 px-2 text-center font-bold text-blue-700 text-lg">${team.points}</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }).join('');

      standingsContainer.innerHTML = html;
    }

    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg font-semibold ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
      } text-white z-50`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b8d946920f09e85',t:'MTc2NzU1OTUyOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>